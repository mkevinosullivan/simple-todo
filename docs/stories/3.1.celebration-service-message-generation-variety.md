# Story 3.1: Celebration Service - Message Generation and Variety

## Status

Done

## Story

**As a** developer, **I want** a CelebrationService that generates varied, encouraging messages, **so that** task completions trigger positive reinforcement without repetition.

## Acceptance Criteria

1. CelebrationService class created with method: `getCelebrationMessage()` returns random celebration message
2. Service maintains pool of at least 10 distinct celebration messages (per PRD FR10)
3. Message variety includes different tones: enthusiastic ("Amazing! You crushed it! ðŸŽ‰"), supportive ("One more done! You're making progress."), data-driven ("Task completed! That's [N] this week."), motivational ("Keep the momentum going!")
4. Messages avoid patronizing language and maintain professional tone suitable for work contexts
5. Message selection uses random algorithm ensuring reasonable distribution (avoid same message twice in a row)
6. Service tracks recently used messages (last 3-5) to minimize immediate repetition
7. Messages can include dynamic data: task count completed today/week, completion streak (if implemented)
8. TypeScript interface defines CelebrationMessage type with text and optional metadata
9. Unit tests verify: message variety (10+ unique), no immediate repetition, random distribution over 100 calls
10. Messages aligned with PRD branding: encouraging without being childish, professional without being sterile

## Tasks / Subtasks

- [x] **Create CelebrationMessage type definition in shared package** (AC: 8)
  - [x] Navigate to `packages/shared/src/types/`
  - [x] Create `CelebrationMessage.ts` with interface definition
  - [x] Define `CelebrationVariant` type: 'enthusiastic' | 'supportive' | 'motivational' | 'data-driven'
  - [x] Define `CelebrationMessage` interface with `message: string`, `variant: CelebrationVariant`, `duration?: number`
  - [x] Export types from `packages/shared/src/types/index.ts`
  - [x] Run `npm run type-check` to verify no errors

- [x] **Create CelebrationService class in backend** (AC: 1, 2, 3, 4)
  - [x] Create file `apps/server/src/services/CelebrationService.ts`
  - [x] Implement constructor with dependencies (TaskService optional, DataService optional for future analytics)
  - [x] Define message pool constant with 10+ messages covering all 4 variants
  - [x] Implement `getCelebrationMessage(taskId?: string): CelebrationMessage` method
  - [x] Ensure messages avoid patronizing language, maintain professional tone
  - [x] Add JSDoc comments for public API methods

- [x] **Implement message rotation logic** (AC: 5, 6)
  - [x] Add private field `recentMessages: string[]` to track last 3-5 messages
  - [x] Implement random selection algorithm that excludes recently used messages
  - [x] Update `recentMessages` array after each message generation
  - [x] Ensure no message repeats in last 5 selections
  - [x] Add validation to prevent infinite loop if pool size < 5

- [x] **Add dynamic data support for data-driven messages** (AC: 7)
  - [x] Inject TaskService into CelebrationService constructor
  - [x] For data-driven variant messages, fetch completed task count
  - [x] Replace placeholder tokens like `[N]` with actual count
  - [x] Handle case when TaskService unavailable (graceful degradation)
  - [x] Test with different task counts (0, 1, 5, 10+)

- [x] **Create comprehensive unit tests** (AC: 9)
  - [x] Create test file `apps/server/tests/unit/services/CelebrationService.test.ts`
  - [x] Test: Service returns 10+ unique messages across multiple calls
  - [x] Test: No immediate repetition (same message twice in a row)
  - [x] Test: Reasonable distribution over 100 calls (each message appears at least once)
  - [x] Test: All 4 variants represented in message pool
  - [x] Test: recentMessages array correctly tracks last 5 messages
  - [x] Test: Dynamic data insertion for data-driven messages
  - [x] Test: Graceful handling when TaskService unavailable
  - [x] Achieve â‰¥70% code coverage (per architecture target for CelebrationService)
  - [x] Run `npm test -w @simple-todo/server -- CelebrationService.test.ts` to verify

- [x] **Verify message tone alignment with PRD** (AC: 4, 10)
  - [x] Review all messages for professional tone (not childish)
  - [x] Review all messages for encouragement (not sterile/robotic)
  - [x] Ensure no patronizing language ("Good boy!", "You're so smart!")
  - [x] Ensure suitable for work contexts (no emojis like ðŸ’©, no slang)
  - [x] Get approval from PM/PO if unclear (optional)

- [x] **Run validation and tests** (All ACs)
  - [x] Run `npm run type-check` - verify TypeScript compiles
  - [x] Run `npm run lint` - verify ESLint passes
  - [x] Run `npm run format:check` - verify Prettier formatting
  - [x] Run `npm test -w @simple-todo/server` - verify all tests pass
  - [x] Run `npm run test:coverage` - verify coverage â‰¥70% for CelebrationService

## Dev Notes

### Epic 3 Context

**Epic Goal:** Add the celebration system to provide positive reinforcement when users complete tasks, creating emotional engagement and building momentum. Implement UX refinements including task age visual indicators, differentiated empty states, and overall polish to create the supportive, encouraging experience defined in the PRD. [Source: docs/prd/epic-3-details-celebration-mechanics-user-experience-polish.md]

**This Story (3.1):** Backend service foundation for celebration system - message generation with variety and rotation logic. This is the first story in Epic 3 and establishes the core celebration message logic that will be consumed by the API endpoint (Story 3.2) and displayed in the UI (Stories 3.3-3.4).

### Previous Story Insights

**From Story 2.9 (Testing and Epic Validation):**
- Established high testing standards: WIPLimitService 100% coverage, AnalyticsService 95% coverage
- Services follow constructor injection pattern for dependencies (enables mocking in tests)
- Test coverage targets for Epic 3: CelebrationService â‰¥70% per architecture/10-testing-strategy.md
- Backend services located in `apps/server/src/services/`
- Unit tests located in `apps/server/tests/unit/services/`
- Testing pattern: Create test file mirroring source structure, use factory functions for test data

### Data Models

**CelebrationMessage Interface** [Source: docs/architecture/4-data-models.md#celebrationmessage]

```typescript
export type CelebrationVariant = 'enthusiastic' | 'supportive' | 'motivational' | 'data-driven';

export interface CelebrationMessage {
  message: string;
  variant: CelebrationVariant;
  duration?: number; // Optional override for display duration (ms)
}
```

**Sample Message Pool** [Source: docs/architecture/4-data-models.md#celebrationmessage]

At least 10 distinct messages required (PRD FR10):
- Enthusiastic: "Amazing! You crushed it! ðŸŽ‰", "Boom! Another one bites the dust! âœ¨", "Crushed it! Keep going! ðŸš€"
- Supportive: "One more done! You're making progress.", "Great work! That's progress!", "Task complete! Nice job staying focused.", "Progress made! You're doing great."
- Motivational: "Task completed! Keep the momentum going!", "Well done! You're on a roll!", "Excellent! You're building momentum!"
- Data-driven: "Task completed! That's [N] this week!" (dynamically insert count)

### Component Specifications

**CelebrationService Class** [Source: docs/architecture/6-components.md#4-celebrationservice]

**File Location:** `apps/server/src/services/CelebrationService.ts`

**Responsibility:** Generate varied celebration messages with rotation to minimize repetition (FR10: 10+ distinct messages).

**Key Interfaces:**
- `getCelebrationMessage(taskId?: string): CelebrationMessage` - Get random celebration, optionally with task context
- `getRecentMessages(): string[]` - Track last 3-5 messages to avoid immediate repetition (internal helper)

**Dependencies:**
- TaskService (optional, for data-driven messages like "That's 5 tasks this week!")
- No persistence (messages hardcoded, recent tracking in-memory)

**Technology Stack:** TypeScript [Source: docs/architecture/3-tech-stack.md]

**Message Pool Strategy:**
- Maintains array of 10+ CelebrationMessage objects with variants
- Random selection weighted to avoid repeating last 3-5 messages
- Data-driven variant dynamically inserts task count: "Task completed! That's {count} this week!"

**Implementation Pattern:**

```typescript
export class CelebrationService {
  private readonly messagePool: CelebrationMessage[];
  private recentMessages: string[] = []; // Track last 5 messages

  constructor(
    private readonly taskService?: TaskService // Optional for data-driven messages
  ) {
    this.messagePool = [...]; // Initialize with 10+ messages
  }

  getCelebrationMessage(taskId?: string): CelebrationMessage {
    // 1. Filter out recently used messages
    // 2. Select random message from remaining pool
    // 3. If data-driven variant, fetch task count and replace [N]
    // 4. Update recentMessages array
    // 5. Return CelebrationMessage
  }
}
```

### File Locations

**Source Code:** [Source: docs/architecture/2-high-level-architecture/repository-structure.md#backend-directory-structure]
- Service class: `apps/server/src/services/CelebrationService.ts`
- Shared types: `packages/shared/src/types/CelebrationMessage.ts`
- Type exports: `packages/shared/src/types/index.ts`

**Test Files:**
- Unit tests: `apps/server/tests/unit/services/CelebrationService.test.ts`
- Test helpers: Use `apps/server/tests/helpers/factories.ts` for test data factories

### Technical Constraints

**Message Requirements:** [Source: Epic 3 PRD]
- Minimum 10 distinct messages (FR10)
- All 4 variants must be represented: enthusiastic, supportive, motivational, data-driven
- Avoid patronizing language ("Good boy!", "You're so smart!")
- Professional tone suitable for work contexts
- No offensive emojis or slang

**Rotation Logic:**
- Track last 3-5 messages to minimize immediate repetition
- Random selection ensures distribution (each message should appear ~equally over time)
- Never show same message twice in a row
- Handle edge case: pool size < 5 (ensure no infinite loop)

**Dynamic Data:**
- Data-driven messages include task count: "That's [N] this week!"
- Use TaskService.getAllTasks() to count completed tasks
- Filter by completedAt timestamp within current week
- Gracefully degrade if TaskService unavailable (use static message)

### Import Path Conventions

[Source: docs/architecture/13-coding-standards-conventions.md#import-path-conventions]

```typescript
// âœ… Correct - absolute imports from shared packages
import type { CelebrationMessage, CelebrationVariant } from '@simple-todo/shared/types';

// âœ… Correct - relative imports within same app (backend)
import { TaskService } from './TaskService';

// Import order (enforced by ESLint):
// 1. React (N/A for backend)
// 2. External dependencies (alphabetical)
// 3. Internal shared packages (alphabetical)
// 4. Parent/sibling files (relative paths)
```

### Coding Standards

[Source: docs/architecture/13-coding-standards-conventions.md]

**File Naming:**
- Service class: PascalCase - `CelebrationService.ts`
- Type file: PascalCase - `CelebrationMessage.ts`
- Test file: Match source + `.test` - `CelebrationService.test.ts`

**TypeScript Standards:**
- Strict mode enabled (no `any` type)
- Explicit return types on public methods
- Use `type` imports for type-only imports
- JSDoc comments for public APIs

**Example JSDoc:**

```typescript
/**
 * Generates a random celebration message with variant for display styling.
 * Avoids showing the same message twice in a row by tracking recent selections.
 *
 * @param taskId - Optional task ID for data-driven message personalization
 * @returns CelebrationMessage with message text, variant, and optional duration
 *
 * @example
 * const celebration = celebrationService.getCelebrationMessage();
 * console.log(celebration.message); // "Amazing! You crushed it! ðŸŽ‰"
 * console.log(celebration.variant); // "enthusiastic"
 */
getCelebrationMessage(taskId?: string): CelebrationMessage {
  // Implementation
}
```

### Testing

#### Testing Framework

[Source: docs/architecture/10-testing-strategy.md]

**Backend Testing:** Jest v29.7+ with TypeScript support

**Test File Location:** `apps/server/tests/unit/services/CelebrationService.test.ts`

**Test Organization:**

```typescript
import { CelebrationService } from '../../../src/services/CelebrationService';
import { TaskService } from '../../../src/services/TaskService';

describe('CelebrationService', () => {
  let celebrationService: CelebrationService;
  let mockTaskService: jest.Mocked<TaskService>;

  beforeEach(() => {
    mockTaskService = {
      getAllTasks: jest.fn(),
    } as any;
    celebrationService = new CelebrationService(mockTaskService);
  });

  describe('getCelebrationMessage', () => {
    it('should return a celebration message with valid variant', () => {
      // Test implementation
    });

    it('should not repeat the same message twice in a row', () => {
      // Test implementation
    });

    // ... more tests
  });
});
```

#### Test Coverage Target

**CelebrationService:** â‰¥70% coverage [Source: docs/architecture/10-testing-strategy.md#coverage-requirements]

**Coverage Areas:**
- Statements: 70%+
- Functions: 70%+
- Branches: 70%+

**Test Execution Commands:**

```bash
# Run CelebrationService tests
npm test -w @simple-todo/server -- CelebrationService.test.ts

# Run with coverage
npm run test:coverage
```

#### Required Test Cases

[Source: AC 9]

1. **Message Variety:** Verify service returns 10+ unique messages across multiple calls
2. **No Immediate Repetition:** Verify same message never appears twice in a row
3. **Reasonable Distribution:** Over 100 calls, each message should appear at least once (statistical distribution test)
4. **Variant Coverage:** Verify all 4 variants (enthusiastic, supportive, motivational, data-driven) present in pool
5. **Recent Messages Tracking:** Verify `recentMessages` array correctly maintains last 5 messages
6. **Dynamic Data Insertion:** Verify data-driven messages correctly insert task count
7. **Graceful Degradation:** Verify service works when TaskService unavailable (no crashes, uses static message)
8. **Edge Case - Small Pool:** Verify no infinite loop when message pool size < 5

#### Test Data Factories

[Source: docs/architecture/10-testing-strategy.md#test-data-factories]

```typescript
// apps/server/tests/helpers/factories.ts
export function createTestCelebrationMessage(overrides: Partial<CelebrationMessage> = {}): CelebrationMessage {
  return {
    message: 'Test celebration message',
    variant: 'supportive',
    ...overrides,
  };
}
```

### Validation Checklist

Before marking story complete:

- [ ] TypeScript compiles without errors (`npm run type-check`)
- [ ] ESLint passes (`npm run lint`)
- [ ] Prettier formatting applied (`npm run format:check`)
- [ ] All unit tests pass (`npm test -w @simple-todo/server`)
- [ ] Coverage â‰¥70% for CelebrationService (`npm run test:coverage`)
- [ ] All 10 ACs validated
- [ ] No console.log statements in production code
- [ ] JSDoc comments on all public methods
- [ ] Conventional commit message format

## Change Log

| Date       | Version | Description          | Author   |
|------------|---------|----------------------|----------|
| 2026-01-30 | 1.0     | Story created        | Bob (SM) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5

### Debug Log References

None

### Completion Notes List

- Task 1: CelebrationMessage and CelebrationVariant types created in shared package
- Task 2: CelebrationService class created with 11 messages (3 enthusiastic, 4 supportive, 3 motivational, 1 data-driven)
- Task 3: Message rotation logic implemented with tracking of last 5 messages to prevent repetition
- Task 4: Dynamic data support added with TaskService integration for data-driven messages showing completed task count this week
- Task 5: Comprehensive unit tests created with 10 test cases achieving >70% coverage
- Task 6: All messages verified for professional tone, encouraging language, no patronizing content, work-appropriate
- Task 7: All validation checks passed (type-check, lint, format-check, tests, coverage)

### File List

**Created:**
- apps/server/src/services/CelebrationService.ts
- apps/server/tests/unit/services/CelebrationService.test.ts

**Modified:**
- packages/shared/src/types/Celebration.ts
- packages/shared/src/types/index.ts

## QA Results

### Review Date: 2026-01-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: Excellent** - This is a well-crafted implementation that demonstrates strong software engineering practices. The code is clean, maintainable, and follows established patterns from previous stories in the epic.

**Strengths:**
- Clean separation of concerns with private helper methods for complex logic
- Proper use of TypeScript readonly modifiers for immutability guarantees
- Async/await implemented correctly throughout
- Constructor dependency injection enables testability
- Graceful degradation when TaskService is unavailable
- Comprehensive JSDoc documentation on public APIs
- Error handling with try-catch in critical paths

**Code Architecture:**
- Message pool properly isolated as immutable constant
- Recent message tracking implemented efficiently with array operations
- Week calculation logic is sound (Sunday-based week start)
- Dynamic message generation cleanly separated into private method

### Refactoring Performed

**File**: apps/server/src/services/CelebrationService.ts
**Change**: Removed unnecessary type assertions (`as CelebrationVariant`) from all message pool entries
**Why**: TypeScript can infer the variant type from the string literal values when the array is typed as `ReadonlyArray<CelebrationMessage>`. The explicit type casts add noise without providing additional type safety.
**How**: Simplified 11 lines from `variant: 'enthusiastic' as CelebrationVariant` to `variant: 'enthusiastic'`. This improves readability while maintaining full type safety. Tests verified no regression.

### Requirements Traceability

Mapped all 10 Acceptance Criteria to test coverage:

| AC | Requirement | Test Coverage | Status |
|---|---|---|---|
| AC1 | getCelebrationMessage() method | "should return a celebration message with valid variant" | âœ“ PASS |
| AC2 | Pool of 10+ messages | "should return at least 10 unique messages" + code shows 11 messages | âœ“ PASS |
| AC3 | 4 message tones/variants | "should include all 4 variants in message pool" | âœ“ PASS |
| AC4 | Avoid patronizing language | Manual review: all messages professional, encouraging | âœ“ PASS |
| AC5 | Random selection, no immediate repeat | "should not repeat the same message twice in a row" | âœ“ PASS |
| AC6 | Track last 3-5 messages | "should track recent messages correctly (no repetition within last 5)" | âœ“ PASS |
| AC7 | Dynamic data support | "should insert dynamic data for data-driven messages" + "should count only completed tasks from current week" | âœ“ PASS |
| AC8 | TypeScript interface | Celebration.ts defines CelebrationMessage and CelebrationVariant | âœ“ PASS |
| AC9 | Unit tests verify variety, distribution | 10 comprehensive test cases covering all scenarios | âœ“ PASS |
| AC10 | PRD branding alignment | Manual review: professional tone, work-appropriate, encouraging | âœ“ PASS |

**Coverage Gaps**: None identified. All acceptance criteria have corresponding test validation.

### Compliance Check

- **Coding Standards**: âœ“ PASS
  - File naming: PascalCase âœ“
  - Import ordering: Correct (type imports first, then relative) âœ“
  - Explicit return types on public methods âœ“
  - JSDoc on public APIs âœ“
  - No console.log in production code âœ“

- **Project Structure**: âœ“ PASS
  - Service located in correct directory (apps/server/src/services/) âœ“
  - Types in shared package (packages/shared/src/types/) âœ“
  - Tests mirror source structure âœ“

- **Testing Strategy**: âœ“ PASS
  - Jest used for backend testing âœ“
  - Constructor injection for mocking âœ“
  - Factory functions for test data âœ“
  - Coverage target â‰¥70% met âœ“
  - Unit tests properly isolated âœ“

- **All ACs Met**: âœ“ PASS - All 10 acceptance criteria validated

### Test Architecture Assessment

**Test Suite Quality: Excellent** - 10 comprehensive test cases covering functionality, edge cases, and error scenarios.

**Test Coverage Strengths:**
- All 4 message variants tested
- Statistical distribution testing (100 iterations)
- Edge case: pool size smaller than recent message tracking
- Error scenario: TaskService unavailable (graceful degradation)
- Time-based filtering: only count tasks from current week
- Repetition prevention: no message within last 5 selections

**Test Design Patterns:**
- Proper use of async/await throughout
- Mock TaskService with jest.fn()
- Isolated tests with independent beforeEach setup
- Clear test names following "should..." convention
- Appropriate test data (realistic task objects)

**Test Maintainability:**
- Tests are readable and self-documenting
- No brittle dependencies on implementation details
- Mock setup is clear and minimal
- Each test validates a single concern

**Potential Enhancements** (Optional, not required for gate):
- Could add test for error when getAllTasks() throws (currently caught by try-catch but not explicitly tested)
- Could add boundary test for exact week start timestamp (Sunday 00:00:00)

### NFR Validation

**Security**: âœ“ PASS
- No user input handling (messages are hardcoded)
- No external API calls
- No file I/O
- No authentication/authorization concerns
- Risk Level: LOW

**Performance**: âœ“ PASS
- O(n) filtering where n=11 (message pool size) - negligible
- O(1) array operations for recent message tracking
- Async task counting is efficient (single getAllTasks call)
- No performance bottlenecks identified
- Risk Level: LOW

**Reliability**: âœ“ PASS
- Graceful degradation when TaskService unavailable
- Try-catch error handling in dynamic message generation
- Edge case handled: pool smaller than tracking size
- No potential for infinite loops
- Risk Level: LOW

**Maintainability**: âœ“ PASS
- Code is clean and self-documenting
- JSDoc on public methods
- Clear separation of concerns
- TypeScript provides type safety
- Easy to add new messages to pool
- Risk Level: LOW

### Testability Evaluation

**Controllability**: âœ“ Excellent
- Constructor injection allows easy mocking of TaskService
- Message selection is testable via multiple calls
- Recent message tracking is deterministic

**Observability**: âœ“ Excellent
- Clear return values (CelebrationMessage)
- No hidden side effects
- Easy to verify behavior through assertions

**Debuggability**: âœ“ Excellent
- Clear code flow with descriptive variable names
- Error messages would be clear if thrown
- No complex nested logic
- TypeScript provides type information for debugging

### Security Review

**Findings**: No security concerns identified.

**Analysis**:
- Service operates on hardcoded message strings
- No user input processing
- No sensitive data handling
- No external network calls
- No file system access
- Dependency on TaskService is read-only (getAllTasks)

**Recommendation**: No security-related changes required.

### Performance Considerations

**Current Performance**: Excellent for intended use case.

**Analysis**:
- Message selection: O(n) where n=11 (constant, negligible)
- Recent message tracking: O(1) push/shift operations
- Task counting: O(m) where m=total tasks (acceptable for single completion event)

**Potential Optimizations** (Not urgent, architectural notes):
- If task list grows to 10,000+ tasks, consider caching weekly completed count
- Current implementation is optimal for MVP scale (5-10 pilot users, <100 tasks)

**Recommendation**: No performance changes required for current scope.

### Technical Debt Assessment

**Current Debt**: Minimal

**Items Identified**:
1. **Week calculation assumes Sunday start** (lines 159-163)
   - Impact: LOW
   - Could make configurable for international users
   - Not critical for MVP
   - Future consideration for i18n

2. **Message pool is hardcoded**
   - Impact: LOW
   - Could move to configuration/database for easier updates
   - Acceptable for MVP with 11 messages
   - Consider for future if message personalization needed

**Recommendation**: No action required for MVP. Document for future enhancement backlog.

### Improvements Checklist

**Completed During Review:**
- [x] Refactored unnecessary type assertions in message pool (CelebrationService.ts:19-68)
- [x] Verified all 10 ACs have test coverage
- [x] Validated message tone alignment with PRD
- [x] Confirmed TypeScript compilation and test execution
- [x] Verified 70%+ coverage target met

**Optional Future Enhancements** (Not blocking):
- [ ] Consider configurable week start day for internationalization
- [ ] Add test for getAllTasks() error throwing scenario (edge case)
- [ ] Consider extracting message pool to configuration file (low priority)

### Files Modified During Review

**Modified**:
- apps/server/src/services/CelebrationService.ts (refactoring: removed type assertions)

**Note to Dev**: Please update the File List in the Dev Agent Record if you agree with this refactoring.

### Gate Status

**Gate**: PASS â†’ docs/qa/gates/3.1-celebration-service-message-generation-variety.yml

**Risk Profile**: LOW RISK
- No security concerns
- No performance issues
- Excellent test coverage
- All acceptance criteria met
- Clean, maintainable code

**Quality Score**: 100/100
- 0 FAIL issues Ã— 20 points = 0 deductions
- 0 CONCERNS issues Ã— 10 points = 0 deductions

### Recommended Status

âœ“ **Ready for Done**

This story is complete and meets all quality standards. The implementation is production-ready with excellent test coverage, clean code architecture, and full acceptance criteria satisfaction. No changes required before marking as Done.

**Next Steps**:
1. Developer can merge implementation
2. Update story status to "Done"
3. Proceed to Story 3.2 (Celebration API Endpoint)
