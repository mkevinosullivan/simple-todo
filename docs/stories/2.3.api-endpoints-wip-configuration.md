# Story 2.3: API Endpoints for WIP Configuration

## Status

Done

## Story

**As a** frontend developer, **I want** API endpoints to read and update WIP
limit configuration, **so that** users can customize their WIP limit through the
UI.

## Acceptance Criteria

1. `GET /api/config/wip-limit` - Returns current WIP limit as
   `{ limit: number }`
2. `PUT /api/config/wip-limit` - Updates WIP limit, accepts `{ limit: number }`
   (5-10 range), returns updated config
3. Validation: PUT endpoint rejects limits outside 5-10 range with 400 status
   and error message "WIP limit must be between 5 and 10"
4. `POST /api/tasks` endpoint modified to check WIPLimitService.canAddTask()
   before creating task
5. When WIP limit reached, POST /api/tasks returns 409 Conflict with
   `{ error: string, wipLimitMessage: string }` including helpful message
6. `GET /api/config/wip-limit` includes additional metadata in response:
   `{ limit: number, currentCount: number, canAddTask: boolean }`
7. All config endpoints include proper error handling with descriptive messages
8. Integration tests verify: reading limit, updating limit with valid/invalid
   values, task creation blocked at limit
9. Config changes immediately affect task creation behavior (no restart
   required)
10. Error response for blocked task creation is distinct from other errors
    (status 409 vs 400/500)

## Tasks / Subtasks

- [x] **PREREQUISITE VERIFICATION**: Confirm Story 2.2 completion (AC: all)
  - [x] Verify `apps\server\src\services\WIPLimitService.ts` exists
  - [x] Verify WIPLimitService exports: `canAddTask()`, `getCurrentWIPCount()`,
        `getWIPLimit()`, `setWIPLimit()`, `getWIPLimitMessage()`
  - [x] Verify WIPLimitService unit tests are passing
  - [x] Verify `packages\shared\src\types\Config.ts` contains Config interface
        with wipLimit property
  - [x] Verify DataService has loadConfig() and saveConfig() methods
  - [x] If any verification fails, HALT and notify that Story 2.2 must be
        completed first

- [x] Create Zod validation schemas for WIP configuration endpoints (AC: 2, 3)
  - [x] Open or create `apps\server\src\middleware\validation.ts`
  - [x] Add Zod import: `import { z } from 'zod'`
  - [x] Define `UpdateWipLimitSchema` with limit validation (5-10 range)
  - [x] Create validation middleware factory
        `validateRequest(schema: z.ZodSchema)` that returns Express middleware
  - [x] Middleware should validate request body against schema and return 400
        with Zod error messages on failure

- [x] Create WIP configuration route handlers (AC: 1, 2, 6)
  - [x] Open or create `apps\server\src\routes\config.ts`
  - [x] Import WIPLimitService, validation middleware, and asyncHandler utility
  - [x] Create Express router: `const router = express.Router()`
  - [x] Implement `GET /wip-limit` handler:
    - [x] Call `wipLimitService.getWIPLimit()` to get current limit
    - [x] Call `wipLimitService.getCurrentWIPCount()` to get active task count
    - [x] Call `wipLimitService.canAddTask()` to check if tasks can be added
    - [x] Return JSON:
          `{ limit: number, currentCount: number, canAddTask: boolean }` with
          200 status
  - [x] Implement `PUT /wip-limit` handler with validation middleware:
    - [x] Apply `validateRequest(UpdateWipLimitSchema)` middleware
    - [x] Call `wipLimitService.setWIPLimit(req.body.limit)` to update limit
    - [x] Return updated config with same format as GET endpoint (200 status)
  - [x] Add error handling: catch errors from service layer and map to
        appropriate HTTP responses
  - [x] Export router for use in main app

- [x] Modify task creation endpoint to enforce WIP limit (AC: 4, 5, 10)
  - [x] Open `apps\server\src\routes\tasks.ts`
  - [x] Import WIPLimitService at top of file
  - [x] In `POST /` handler, BEFORE calling `taskService.createTask()`:
    - [x] Call `await wipLimitService.canAddTask()` to check WIP limit
    - [x] If `canAddTask()` returns false:
      - [x] Call `await wipLimitService.getWIPLimitMessage()` to get helpful
            message
      - [x] Return 409 Conflict status with JSON:
            `{ error: "WIP limit reached", wipLimitMessage: string }`
      - [x] Do NOT create the task
    - [x] If `canAddTask()` returns true, proceed with task creation as normal
  - [x] Ensure error response for WIP limit (409) is distinct from validation
        errors (400) and server errors (500)

- [x] Register config routes in Express app (AC: 1, 2)
  - [x] Open `apps\server\src\app.ts` or `apps\server\src\index.ts` (wherever
        routes are registered)
  - [x] Import config router: `import configRouter from './routes/config.js'`
  - [x] Register router: `app.use('/api/config', configRouter)`
  - [x] Ensure config routes come after any global middleware (logging, error
        handling)

- [x] Write integration tests for config endpoints (AC: 8)
  - [x] Create `apps\server\tests\integration\api\config.test.ts`
  - [x] Use supertest to test API endpoints with real Express app
  - [x] Set up test data directory with config.json before each test
  - [x] Clean up test files after each test
  - [x] **Test GET /api/config/wip-limit:**
    - [x] Returns current limit, currentCount, and canAddTask boolean
    - [x] Returns 200 status
  - [x] **Test PUT /api/config/wip-limit:**
    - [x] Accepts valid limit (5, 7, 10) and updates config
    - [x] Returns updated config with 200 status
    - [x] Rejects limit < 5 with 400 and error message
    - [x] Rejects limit > 10 with 400 and error message
    - [x] Rejects non-number input with 400 and Zod validation error
  - [x] **Test config persistence:**
    - [x] Verify updated limit persists across requests (read after write)
  - [x] Run tests: `npm run test -w @simple-todo/server -- config.test.ts`

- [x] Write integration tests for WIP limit enforcement in task creation (AC: 4,
      5, 8, 10)
  - [x] Update `apps\server\tests\integration\api\tasks.test.ts` or create new
        test suite
  - [x] **Test WIP limit enforcement:**
    - [x] Create tasks up to WIP limit (default 7)
    - [x] Verify 8th task returns 409 Conflict status
    - [x] Verify response contains `error` and `wipLimitMessage` fields
    - [x] Verify wipLimitMessage includes helpful text (encouraging tone)
  - [x] **Test task creation under limit:**
    - [x] Create 3 tasks when limit is 7
    - [x] Verify task creation succeeds with 201 status
    - [x] Verify canAddTask remains true
  - [x] **Test config changes affect behavior immediately:**
    - [x] Create 5 tasks
    - [x] Change WIP limit to 5 via PUT /api/config/wip-limit
    - [x] Verify next task creation is blocked with 409 status (no restart
          required)
  - [x] Run tests: `npm run test -w @simple-todo/server -- tasks.test.ts`

- [x] Add JSDoc documentation to config route handlers (AC: 7)
  - [x] Document GET /wip-limit handler with @returns description of response
        format
  - [x] Document PUT /wip-limit handler with @param, @returns, @throws
        annotations
  - [x] Include @example showing typical request/response for each endpoint
  - [x] Follow JSDoc standards from coding-standards.md

- [x] Update API documentation (AC: 1, 2, 6)
  - [x] Verify `docs\architecture\5-api-specification.md` includes WIP config
        endpoints
  - [x] Document request/response formats with examples
  - [x] Document error responses (400, 409, 500) with example payloads

## Dev Notes

### Architectural Context

**Service Layer Pattern** [Source:
docs/architecture/2-high-level-architecture.md#architectural-patterns]:

Routes delegate to services for business logic. The route layer handles HTTP
concerns (status codes, request/response formatting), while services encapsulate
business rules.

```
HTTP Request → Route Handler → Service Layer → Data Layer
                    ↓
              (validates, maps status codes, formats response)
```

**Configuration Management Pattern** [Source:
docs/architecture/2-high-level-architecture.md#configuration-management-pattern]:

Config API routes delegate to different services based on business logic needs:

- `/api/config/wip-limit` → WIPLimitService (validation, business logic, helpful
  messages)
- `/api/config/prompting` → PromptingService (update config + restart scheduler)
- `/api/config/celebrations` → DataService (simple validation + persistence)
- `/api/config` GET → DataService (read entire config object)

**Rationale:** Services own their configuration updates when side effects are
needed (scheduler restart, validation logic), otherwise direct DataService
access keeps it simple.

### Prerequisites

**CRITICAL:** This story depends on **Story 2.2 (WIP Limit Service - Business
Logic)** being completed.

**Verification Status (Confirmed by PO 2026-01-28):**

- ✅ `apps\server\src\services\WIPLimitService.ts` exists with all required
  methods
- ✅ Config interface exists in `packages\shared\src\types\Config.ts` with
  wipLimit property
- ✅ `apps\server\src\utils\asyncHandler.ts` exists and is available for route
  wrapping
- ⚠️ `UpdateWipLimitDto` interface does NOT exist yet - will be created via Zod
  schema inference in this story
- ⚠️ WIPLimitService unit tests status - verify before starting
- ⚠️ DataService loadConfig() and saveConfig() methods - verify before starting

**FIRST TASK: Run prerequisite verification checklist before beginning
implementation**

### Previous Story Insights (Story 2.2)

**Key Learnings:**

- WIPLimitService provides `canAddTask()`, `getWIPLimit()`, `setWIPLimit()`,
  `getCurrentWIPCount()`, and `getWIPLimitMessage()` methods
- WIP limit validation (5-10 range) is already implemented in
  WIPLimitService.setWIPLimit()
- Config stored in `./data/config.json` with atomic file writes
- WIPLimitService returns helpful, encouraging messages (not punitive)
- JSDoc documentation required for all public APIs
- TypeScript strict mode enforces explicit return types

### REST API Patterns

**HTTP Status Code Conventions** [Source:
docs/architecture/5-api-specification.md]:

| Status Code               | Use Case                | Example                                      |
| ------------------------- | ----------------------- | -------------------------------------------- |
| 200 OK                    | Successful GET or PUT   | Config retrieved/updated successfully        |
| 201 Created               | Successful POST         | Task created successfully                    |
| 400 Bad Request           | Validation error        | Invalid WIP limit (out of range, non-number) |
| 409 Conflict              | Business rule conflict  | WIP limit reached, cannot add task           |
| 500 Internal Server Error | Unexpected server error | File system error, service exception         |

**CRITICAL - Status 409 vs 400:**

- 400 (Bad Request): Client sent invalid data format (validation failed)
- 409 (Conflict): Request is valid but conflicts with current state (WIP limit
  reached)

### Input Validation with Zod

**Zod Validation Pattern** [Source: docs/architecture/3-tech-stack.md]:

Zod provides TypeScript-first schema validation for runtime type checking and
prevents injection attacks.

```typescript
// Define schema
const UpdateWipLimitSchema = z.object({
  limit: z.number().int().min(5).max(10),
});

// Validation middleware factory
function validateRequest(schema: z.ZodSchema) {
  return (
    req: express.Request,
    res: express.Response,
    next: express.NextFunction
  ) => {
    const result = schema.safeParse(req.body);

    if (!result.success) {
      return res.status(400).json({
        error: 'Validation failed',
        details: result.error.errors,
      });
    }

    next();
  };
}

// Apply to route
router.put(
  '/wip-limit',
  validateRequest(UpdateWipLimitSchema),
  async (req, res) => {
    // req.body.limit is validated and type-safe here
  }
);
```

**Benefits:**

- Runtime validation catches invalid data before it reaches services
- Type inference provides TypeScript types from schemas
- Descriptive error messages for invalid inputs
- Prevents injection attacks and type coercion issues

### Data Models

**Config Interface** [Source: docs/architecture/4-data-models.md#config]:

```typescript
export interface Config {
  wipLimit: number; // 5-10 range
  promptingEnabled: boolean;
  promptingFrequencyHours: number; // 1-6 range
  celebrationsEnabled: boolean;
  celebrationDurationSeconds: number; // 3-10 range
  browserNotificationsEnabled: boolean;
  hasCompletedSetup: boolean;
  hasSeenPromptEducation: boolean;
}

export interface UpdateWipLimitDto {
  limit: number; // Must be 5-10
}

// NOTE: UpdateWipLimitDto does NOT currently exist in packages/shared/src/types/Config.ts
// This story will define it implicitly via Zod schema inference in the validation middleware
// TypeScript will infer the type from the Zod schema: z.infer<typeof UpdateWipLimitSchema>
```

**WIP Limit Response Format (AC 6):**

```typescript
// GET /api/config/wip-limit response
{
  limit: number; // Current WIP limit (5-10)
  currentCount: number; // Number of active tasks
  canAddTask: boolean; // True if count < limit
}
```

**WIP Limit Error Response Format (AC 5, 10):**

```typescript
// POST /api/tasks response when WIP limit reached (409 status)
{
  error: string; // "WIP limit reached"
  wipLimitMessage: string; // Encouraging message from WIPLimitService
}
```

### File Locations

**Files to Create:**

- `apps\server\src\middleware\validation.ts` - Zod validation middleware factory
- `apps\server\src\routes\config.ts` - Config API route handlers
- `apps\server\tests\integration\api\config.test.ts` - Integration tests for
  config endpoints

**Files to Modify:**

- `apps\server\src\routes\tasks.ts` - Add WIP limit check to POST /api/tasks
- `apps\server\src\app.ts` (or `index.ts`) - Register config router
- `apps\server\tests\integration\api\tasks.test.ts` - Add WIP limit enforcement
  tests
- `docs\architecture\5-api-specification.md` - Document new endpoints

**No Changes to:**

- `apps\server\src\services\WIPLimitService.ts` - Service already implemented in
  Story 2.2
- `packages\shared\src\types\Config.ts` - Config interface already exists
- `apps\server\src\services\DataService.ts` - Config persistence already
  implemented

**IMPORTANT - Windows File Paths:** Per CLAUDE.md requirements, when using Edit
or Write tools on Windows, you MUST use backslashes (`\`) in file paths, not
forward slashes (`/`). All file paths in this story follow this convention and
must be used exactly as specified.

### WIPLimitService Methods Available

**WIPLimitService API** [Source: apps/server/src/services/WIPLimitService.ts]:

```typescript
class WIPLimitService {
  /**
   * Get current WIP limit from configuration
   * @returns Current WIP limit (5-10)
   */
  async getWIPLimit(): Promise<number>;

  /**
   * Update WIP limit configuration
   * @param limit - New WIP limit (must be 5-10)
   * @throws {Error} If limit is outside 5-10 range
   */
  async setWIPLimit(limit: number): Promise<void>;

  /**
   * Get count of active tasks
   * @returns Number of tasks with status 'active'
   */
  async getCurrentWIPCount(): Promise<number>;

  /**
   * Check if a new task can be added without exceeding WIP limit
   * @returns True if count < limit, false otherwise
   */
  async canAddTask(): Promise<boolean>;

  /**
   * Generate encouraging message when WIP limit is reached
   * @returns Helpful message like "You have 7 active tasks - complete one before adding more to maintain focus!"
   */
  async getWIPLimitMessage(): Promise<string>;
}
```

**Usage in Route Handlers:**

```typescript
// GET /api/config/wip-limit
const limit = await wipLimitService.getWIPLimit();
const currentCount = await wipLimitService.getCurrentWIPCount();
const canAddTask = await wipLimitService.canAddTask();

res.status(200).json({ limit, currentCount, canAddTask });
```

```typescript
// PUT /api/config/wip-limit (after Zod validation)
await wipLimitService.setWIPLimit(req.body.limit);

// Return updated state
const limit = await wipLimitService.getWIPLimit();
const currentCount = await wipLimitService.getCurrentWIPCount();
const canAddTask = await wipLimitService.canAddTask();

res.status(200).json({ limit, currentCount, canAddTask });
```

```typescript
// POST /api/tasks (WIP limit check)
const canAdd = await wipLimitService.canAddTask();

if (!canAdd) {
  const wipLimitMessage = await wipLimitService.getWIPLimitMessage();
  return res.status(409).json({
    error: 'WIP limit reached',
    wipLimitMessage,
  });
}

// Proceed with task creation...
```

### Error Handling Pattern

**Route Layer Error Mapping** [Source:
docs/architecture/2-high-level-architecture.md#backend-patterns]:

Routes catch errors from services and map to HTTP status codes:

```typescript
// Example route handler with error mapping
router.put(
  '/wip-limit',
  validateRequest(UpdateWipLimitSchema),
  async (req, res) => {
    try {
      await wipLimitService.setWIPLimit(req.body.limit);

      const limit = await wipLimitService.getWIPLimit();
      const currentCount = await wipLimitService.getCurrentWIPCount();
      const canAddTask = await wipLimitService.canAddTask();

      res.status(200).json({ limit, currentCount, canAddTask });
    } catch (error) {
      // WIPLimitService throws "WIP limit must be between 5 and 10"
      if (error.message?.includes('must be between')) {
        return res.status(400).json({ error: error.message });
      }

      // Generic server error
      console.error('Failed to update WIP limit:', error);
      res.status(500).json({ error: 'Internal server error' });
    }
  }
);
```

**Error Types and Status Codes:**

- Zod validation errors → 400 (caught by validation middleware)
- WIPLimitService validation errors → 400 (caught in route handler)
- WIP limit reached (canAddTask = false) → 409 (business rule conflict)
- DataService file I/O errors → 500 (unexpected server error)

### TypeScript and Coding Standards

**TypeScript Standards** [Source:
docs/architecture/13-coding-standards-conventions.md#typescript-standards]:

- Strict mode enabled: `noImplicitAny`, `strictNullChecks`,
  `strictFunctionTypes`
- All public methods must have explicit return types
- Use `type` keyword for type-only imports:
  `import type { Config } from '@simple-todo/shared/types'`
- No `any` types allowed

**Import Path Conventions** [Source:
docs/architecture/13-coding-standards-conventions.md#import-path-conventions]:

```typescript
// ✅ Correct - absolute imports from shared packages
import type { Config, UpdateWipLimitDto } from '@simple-todo/shared/types';
import { z } from 'zod';

// ✅ Correct - relative imports within apps/server
import { WIPLimitService } from '../services/WIPLimitService.js';
import { asyncHandler } from '../utils/asyncHandler.js';
import { validateRequest } from '../middleware/validation.js';
```

**Note:** Use `.js` extensions in imports despite `.ts` source files (ES modules
requirement).

**JSDoc Documentation Requirements** [Source:
docs/architecture/13-coding-standards-conventions.md#documentation-standards]:

All route handlers must have JSDoc comments with @param, @returns, @throws, and
@example:

```typescript
/**
 * Get current WIP limit configuration with metadata
 *
 * @returns WIP limit, current active task count, and whether tasks can be added
 * @throws {Error} If unable to read config or query task count
 *
 * @example
 * GET /api/config/wip-limit
 * Response: { limit: 7, currentCount: 3, canAddTask: true }
 */
router.get('/wip-limit', async (req, res) => {
  // Implementation
});
```

### Async Handler Utility

**AsyncHandler Pattern** [Source: apps/server/src/utils/asyncHandler.ts -
VERIFIED EXISTS]:

✅ **Available for Use** - The asyncHandler utility exists in the codebase and
is ready for use.

Wraps async route handlers to catch errors and pass to Express error handler:

```typescript
// apps/server/src/utils/asyncHandler.ts (EXISTING UTILITY)
import type { RequestHandler } from 'express';

export const asyncHandler = <P, ResBody, ReqBody, ReqQuery, Locals>(
  fn: (req, res, next) => Promise<void>
): RequestHandler => {
  return (req, res, next): void => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};

// Usage in routes
import { asyncHandler } from '../utils/asyncHandler.js';

router.get(
  '/wip-limit',
  asyncHandler(async (req, res) => {
    // Any thrown errors are caught and passed to error handler middleware
    const limit = await wipLimitService.getWIPLimit();
    res.json({ limit });
  })
);
```

**Recommendation:** Use asyncHandler to wrap all async route handlers for
consistent error handling.

### Service Instantiation

**Singleton Service Pattern** [Source:
docs/architecture/2-high-level-architecture.md#backend-patterns]:

Services are instantiated once and shared across requests (localhost single-user
app):

```typescript
// apps/server/src/routes/config.ts
import express from 'express';
import { WIPLimitService } from '../services/WIPLimitService.js';
import { TaskService } from '../services/TaskService.js';
import { DataService } from '../services/DataService.js';

const router = express.Router();

// Instantiate services (singleton pattern for localhost app)
const dataService = new DataService();
const taskService = new TaskService(dataService);
const wipLimitService = new WIPLimitService(taskService, dataService);

// Route handlers use shared service instances
router.get('/wip-limit', async (req, res) => {
  const limit = await wipLimitService.getWIPLimit();
  // ...
});

export default router;
```

**Rationale:** Single-user localhost app has no concurrency concerns, shared
instances simplify architecture.

### Testing

#### Integration Testing Strategy

**Testing Framework:** Jest 29.7+ with supertest for API testing [Source:
docs/architecture/3-tech-stack.md#testing]

**Test File Location:** `apps\server\tests\integration\api\config.test.ts`
[Source: docs/architecture/10-testing-strategy.md#test-organization]

**Testing Approach:**

- Use real Express app (not mocked)
- Use real DataService with temporary test files (not mocked)
- Tests verify full request → response flow including file I/O
- Clean up test files after each test

**Test Setup Pattern:**

```typescript
import request from 'supertest';
import { app } from '../../../src/app';
import fs from 'fs/promises';
import path from 'path';

const TEST_DATA_DIR = path.join(__dirname, '../../test-data');

describe('Config API', () => {
  beforeEach(async () => {
    // Create temporary test data directory
    await fs.mkdir(TEST_DATA_DIR, { recursive: true });

    // Initialize test config
    await fs.writeFile(
      path.join(TEST_DATA_DIR, 'config.json'),
      JSON.stringify({ wipLimit: 7 }),
      'utf-8'
    );

    // Initialize empty tasks array
    await fs.writeFile(
      path.join(TEST_DATA_DIR, 'tasks.json'),
      JSON.stringify([]),
      'utf-8'
    );
  });

  afterEach(async () => {
    // Clean up test files
    await fs.rm(TEST_DATA_DIR, { recursive: true, force: true });
  });

  // Test cases...
});
```

#### Test Cases Required

**Integration Tests - Config Endpoints:**

1. **GET /api/config/wip-limit**
   - Returns current limit, currentCount, and canAddTask
   - Returns 200 status
   - Response matches expected JSON structure

2. **PUT /api/config/wip-limit (valid values)**
   - Accepts limit = 5 (minimum boundary)
   - Accepts limit = 7 (middle value)
   - Accepts limit = 10 (maximum boundary)
   - Returns updated config with 200 status
   - Changes persist in config.json file

3. **PUT /api/config/wip-limit (invalid values)**
   - Rejects limit = 4 (below minimum) with 400 status
   - Rejects limit = 11 (above maximum) with 400 status
   - Rejects limit = 0 with 400 status
   - Rejects limit = -1 with 400 status
   - Rejects non-number input (string, null, undefined) with 400 status
   - Error messages are descriptive and match Zod validation format

4. **Config Persistence**
   - Updated limit persists across GET requests
   - File content matches in-memory state
   - Atomic writes prevent corruption

**Integration Tests - WIP Limit Enforcement in Task Creation:**

1. **Task Creation Under Limit**
   - Create 3 tasks when limit is 7
   - All tasks created successfully with 201 status
   - GET /api/config/wip-limit shows currentCount = 3, canAddTask = true

2. **Task Creation At Limit**
   - Create 7 tasks when limit is 7
   - 7th task created successfully with 201 status
   - 8th task blocked with 409 Conflict status
   - Error response includes `error` and `wipLimitMessage` fields
   - wipLimitMessage contains encouraging text (not punitive)

3. **Config Changes Affect Behavior Immediately (AC 9)**
   - Create 5 tasks when limit is 7
   - Change limit to 5 via PUT /api/config/wip-limit
   - Next task creation blocked with 409 status (no restart required)
   - Change limit to 10 via PUT /api/config/wip-limit
   - Next task creation succeeds with 201 status

4. **Error Response Distinction (AC 10)**
   - WIP limit error: 409 status with wipLimitMessage
   - Validation error (empty text): 400 status
   - Server error (file system): 500 status
   - Each error type has distinct response format

#### Test Commands

```bash
# Run config integration tests only
npm run test -w @simple-todo/server -- config.test.ts

# Run tasks integration tests (including WIP enforcement)
npm run test -w @simple-todo/server -- tasks.test.ts

# Run all integration tests
npm run test -w @simple-todo/server -- integration/

# Run tests with coverage
npm run test:coverage -w @simple-todo/server

# Run in watch mode (for development)
npm run test -w @simple-todo/server -- --watch
```

#### Expected Test Output

When all tests pass:

```
PASS apps/server/tests/integration/api/config.test.ts
  GET /api/config/wip-limit
    ✓ should return current WIP limit configuration (45 ms)
    ✓ should include currentCount and canAddTask metadata (38 ms)
  PUT /api/config/wip-limit
    ✓ should accept valid limit at minimum boundary (5) (52 ms)
    ✓ should accept valid limit at middle value (7) (48 ms)
    ✓ should accept valid limit at maximum boundary (10) (50 ms)
    ✓ should reject limit below minimum (4) with 400 status (42 ms)
    ✓ should reject limit above maximum (11) with 400 status (40 ms)
    ✓ should reject non-number input with 400 status (38 ms)
  Config Persistence
    ✓ should persist limit changes across requests (55 ms)

PASS apps/server/tests/integration/api/tasks.test.ts
  POST /api/tasks (WIP Limit Enforcement)
    ✓ should allow task creation when under WIP limit (60 ms)
    ✓ should block task creation when at WIP limit with 409 status (70 ms)
    ✓ should include wipLimitMessage in 409 response (65 ms)
    ✓ should enforce updated limit immediately without restart (80 ms)
    ✓ should return 409 for WIP limit, 400 for validation errors (55 ms)

Test Suites: 2 passed, 2 total
Tests:       14+ passed, 14+ total
Time:        1.5 s
```

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5

### Debug Log References

None

### Completion Notes

- All 9 tasks completed successfully
- Created validation middleware with Zod v3.22 (downgraded from v4 for Jest
  compatibility)
- Implemented GET and PUT endpoints for WIP limit configuration
- Modified POST /api/tasks to enforce WIP limit with 409 Conflict status
- Registered config routes in Express app
- All integration tests passing (122/122 tests)
- All validations passing (type-check, lint, format-check)
- API documentation updated with detailed endpoint specifications

### File List

**Created:**

- `apps\server\src\middleware\validation.ts` - Zod validation middleware with
  UpdateWipLimitSchema
- `apps\server\src\routes\config.ts` - Config API route handlers (GET/PUT
  /wip-limit)
- `apps\server\tests\integration\api\config.test.ts` - Config endpoint
  integration tests (15 tests)

**Modified:**

- `apps\server\src\app.ts` - Registered config router
- `apps\server\src\routes\tasks.ts` - Added WIP limit enforcement to POST
  /api/tasks
- `apps\server\tests\integration\api\tasks.test.ts` - Added WIP limit
  enforcement tests (6 tests)
- `docs\architecture\5-api-specification.md` - Added detailed WIP config
  endpoint documentation
- `apps\server\package.json` - Added zod@3.22 dependency

## QA Results

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT**

This implementation demonstrates outstanding software engineering practices with comprehensive test coverage, clean architecture, and production-ready code quality. The team has delivered a well-documented, type-safe API implementation that fully meets all acceptance criteria.

**Highlights:**
- Clean separation of concerns across validation, routing, and service layers
- Type-safe Zod validation preventing injection attacks and invalid data
- Comprehensive JSDoc documentation on all public APIs
- 122/122 tests passing with excellent integration test coverage
- Proper HTTP status code usage (409 for WIP conflict vs 400 for validation)
- Immediate config propagation without restart (AC 9)

**Architecture Pattern Adherence:**
- Follows established service layer pattern perfectly
- Singleton service instantiation appropriate for localhost app
- Validation middleware factory is reusable and well-designed
- Error handling maps service exceptions to appropriate HTTP responses

### Refactoring Performed

**File: docs/stories/2.3.api-endpoints-wip-configuration.md**
- **Change:** Fixed Prettier formatting issues in story file
- **Why:** Ensure code style consistency across documentation
- **How:** Ran `npx prettier --write` on story file

No code refactoring was necessary - the implementation is clean and follows best practices throughout.

### Compliance Check

- **Coding Standards:** ✓ PASS - Follows TypeScript strict mode, explicit return types, type-only imports
- **Project Structure:** ✓ PASS - Matches monorepo structure with proper workspace organization
- **Testing Strategy:** ✓ PASS - Integration tests with real services, proper setup/teardown
- **All ACs Met:** ✓ PASS - All 10 acceptance criteria fully implemented and tested

### Requirements Traceability (Given-When-Then)

**AC 1: GET /api/config/wip-limit returns current limit**
- **Given** the system has a configured WIP limit
- **When** GET /api/config/wip-limit is called
- **Then** it returns { limit: number }
- **Tests:** config.test.ts:52-60 ✓

**AC 2: PUT /api/config/wip-limit updates limit (5-10 range)**
- **Given** a valid limit value between 5 and 10
- **When** PUT /api/config/wip-limit is called with { limit: number }
- **Then** the limit is updated and returned in the response
- **Tests:** config.test.ts:140-183 (boundaries: 5, 7, 10) ✓

**AC 3: Validation rejects limits outside 5-10 range with 400**
- **Given** an invalid limit value (< 5 or > 10, non-integer, or non-number)
- **When** PUT /api/config/wip-limit is called
- **Then** it returns 400 with descriptive Zod validation error
- **Tests:** config.test.ts:185-255 (tests: 4, 11, 0, -1, 7.5, "7", missing) ✓

**AC 4: POST /api/tasks checks WIPLimitService.canAddTask() before creating**
- **Given** a request to create a new task
- **When** POST /api/tasks is called
- **Then** it first calls wipLimitService.canAddTask() before task creation
- **Code:** tasks.ts:56-64 ✓
- **Tests:** tasks.test.ts:431-445, 447-462 ✓

**AC 5: When WIP limit reached, POST /api/tasks returns 409 with error and wipLimitMessage**
- **Given** the active task count equals the WIP limit
- **When** POST /api/tasks is called
- **Then** it returns 409 Conflict with { error: "WIP limit reached", wipLimitMessage: string }
- **Tests:** tasks.test.ts:447-462, 464-478 ✓

**AC 6: GET /api/config/wip-limit includes metadata (limit, currentCount, canAddTask)**
- **Given** the system has active tasks
- **When** GET /api/config/wip-limit is called
- **Then** it returns { limit: number, currentCount: number, canAddTask: boolean }
- **Tests:** config.test.ts:52-60, 62-96, 98-136 ✓

**AC 7: All config endpoints include proper error handling**
- **Given** any error condition (file I/O, validation, etc.)
- **When** a config endpoint is called
- **Then** it returns appropriate HTTP status (400/500) with descriptive error messages
- **Code:** config.ts:55-59, 128-149 ✓
- **Tests:** Error scenarios tested throughout config.test.ts ✓

**AC 8: Integration tests verify all scenarios**
- **Given** the full application stack
- **When** tests execute against real services
- **Then** all scenarios are validated: read/update limit, valid/invalid values, task creation at limit
- **Tests:** 15 tests in config.test.ts + 6 tests in tasks.test.ts = 21 total ✓

**AC 9: Config changes immediately affect task creation behavior (no restart)**
- **Given** the WIP limit is updated via API
- **When** task creation is attempted immediately after
- **Then** the new limit is enforced without requiring server restart
- **Tests:** tasks.test.ts:480-501 ✓

**AC 10: Error response for blocked task creation is distinct (status 409 vs 400/500)**
- **Given** different error conditions
- **When** errors occur
- **Then** 409 for WIP limit, 400 for validation, 500 for server errors - each with distinct response format
- **Tests:** tasks.test.ts:503-538 ✓

### Test Architecture Analysis

**Test Coverage: EXCELLENT (100% of ACs covered)**
- 21 integration tests added (15 config + 6 WIP enforcement)
- All acceptance criteria have corresponding test cases
- Boundary value testing (5, 10)
- Edge case testing (0, -1, non-integer, string, missing field)
- Error scenario coverage (400, 409, 500)

**Test Design Quality: EXCELLENT**
- Integration tests use real Express app and services (not mocked)
- Proper test isolation with beforeEach/afterEach setup/teardown
- Tests verify both HTTP responses AND file persistence
- Clear test naming following Given-When-Then pattern
- Temporary test directories prevent test interference

**Test Level Appropriateness:**
- ✓ Integration tests for API endpoints (correct level)
- ✓ Unit tests for WIPLimitService already exist from Story 2.2
- ✓ End-to-end tests not needed for this backend-only story

### Security Review

**Status: PASS - No security concerns**

**Positive Findings:**
- ✓ Zod validation prevents injection attacks and type coercion vulnerabilities
- ✓ Input validation on all endpoints (limit range, UUID format)
- ✓ No sensitive data exposure in responses
- ✓ Proper error messages (descriptive but not leaking implementation details)
- ✓ Validation middleware logs validation failures for security monitoring

**No Issues Found**

### Performance Considerations

**Status: PASS - No performance concerns**

**Analysis:**
- ✓ Lightweight operations (config reads, task counting)
- ✓ Async/await for non-blocking I/O
- ✓ No N+1 queries or performance anti-patterns
- ✓ Atomic file writes prevent corruption
- ✓ Config caching not needed (localhost single-user app)

**No Issues Found**

### Non-Functional Requirements Validation

**Security:** ✓ PASS
- Zod validation prevents injection
- Input validation on all endpoints
- Proper error handling without information leakage

**Performance:** ✓ PASS
- Lightweight operations
- Non-blocking async I/O
- Appropriate for localhost workload

**Reliability:** ✓ PASS
- Comprehensive error handling
- Atomic file writes (from DataService)
- Graceful degradation
- All 122 tests passing

**Maintainability:** ✓ PASS
- Excellent JSDoc documentation
- Clear code structure
- Type-safe implementation
- Reusable validation middleware

### Testability Evaluation

- **Controllability:** ✓ EXCELLENT - Can control all inputs via request parameters
- **Observability:** ✓ EXCELLENT - Can observe outputs (HTTP responses, file contents)
- **Debuggability:** ✓ EXCELLENT - Descriptive error messages, comprehensive logging

### Technical Debt Assessment

**Status: NONE IDENTIFIED**

This implementation introduces no technical debt. The code is clean, well-tested, properly documented, and follows established architectural patterns.

### Files Modified During Review

**Modified:**
- `docs\stories\2.3.api-endpoints-wip-configuration.md` - Fixed Prettier formatting

### Gate Status

**Gate: PASS** → docs/qa/gates/2.3-api-endpoints-wip-configuration.yml

**Quality Score: 100/100**

**All acceptance criteria met with excellent implementation quality.**

### Recommended Status

✓ **Ready for Done**

This story is complete and ready to be marked as Done. All acceptance criteria are met, tests are passing, documentation is comprehensive, and code quality is excellent. No changes required.

## Change Log

| Date       | Version | Description                         | Author             |
| ---------- | ------- | ----------------------------------- | ------------------ |
| 2026-01-27 | 1.0     | Initial story creation for Epic 2.3 | Bob (Scrum Master) |
