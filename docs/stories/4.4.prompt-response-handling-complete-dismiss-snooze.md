# Story 4.4: Prompt Response Handling - Complete/Dismiss/Snooze

<!-- Powered by BMAD‚Ñ¢ Core -->

## Status

Done

## Story

**As a** user,
**I want** to respond to task prompts by completing, dismissing, or snoozing them,
**so that** I have control over how I engage with proactive suggestions.

## Acceptance Criteria

1. Clicking "Complete" button on toast calls `PATCH /api/tasks/:id/complete` and triggers celebration
2. After completing task via prompt, toast disappears and celebration appears (same as manual completion)
3. Clicking "Dismiss" button removes toast immediately, no other action taken
4. Clicking "Snooze" button dismisses toast and reschedules prompt for same task in 1 hour (per PRD FR12)
5. API endpoint created: `POST /api/prompts/snooze` accepts `{ taskId: string }` and schedules future prompt
6. Snooze scheduling tracked in memory or persisted to prevent duplicate prompts for same task
7. If snoozed task is completed or deleted before snooze time, scheduled prompt is cancelled
8. Prompt response tracking logged for analytics: track response type (complete/dismiss/snooze) and timestamp
9. User can't be prompted for same task twice within 24 hours (prevents annoying repetition)
10. Integration tests verify: complete response triggers task completion, dismiss removes toast, snooze reschedules

## Tasks / Subtasks

**Implementation Order:** Tasks 1-2 can be developed in parallel. Task 3 integrates backend with frontend. Tasks 4-5 add tracking and testing.

- [x] **Task 1: Implement Backend Snooze Endpoint** (AC: 4, 5, 6, 7, 9)
  - [x] Create `POST /api/prompts/snooze` endpoint in `apps/server/src/routes/prompts.ts`
    - Route handler accepts `SnoozePromptDto: { taskId: string }`
    - Validates taskId is valid UUID format using regex
    - Returns 200 OK with no body on success
    - Returns 400 Bad Request if taskId invalid or missing
    - Returns 404 Not Found if task doesn't exist
    - [Source: docs/architecture/5-api-specification.md#REST API Endpoints Summary]
  - [x] Add `snoozePrompt(taskId: string)` method to PromptingService
    - Validate task exists using TaskService.getTaskById()
    - Schedule prompt for taskId exactly 1 hour from now using setTimeout
    - Store scheduled prompt in memory Map: `snoozedPrompts: Map<taskId, timeoutId>`
    - Prevent duplicate snoozes for same taskId (cancel existing if re-snoozed)
    - When snooze timer fires, call onSnoozedPrompt() for specific taskId
    - [Source: docs/architecture/6-components.md#5. PromptingService]
  - [x] Implement snooze cancellation on task lifecycle events (AC: 7)
    - Implemented via validation in onSnoozedPrompt: checks if task exists and is active before prompting
    - Added cancelSnooze() method for explicit cancellation
    - Snoozed prompts self-cancel when task is deleted/completed
  - [x] Add 24-hour prompt cooldown tracking (AC: 9)
    - Create Map: `recentlyPromptedTasks: Map<taskId, timestamp>`
    - In selectTaskForPrompt(), filter out tasks prompted within last 24 hours
    - When prompt generated, add taskId + current timestamp to Map
    - Periodically clean up Map entries older than 24 hours (every hour check)
  - [x] Wire endpoint to PromptingService in routes/prompts.ts
    - Call promptingService.snoozePrompt(taskId)
    - Handle errors with try-catch, return 404 if task not found, 500 for other errors

- [x] **Task 2: Implement Prompt Response Tracking for Analytics** (AC: 8)
  - [x] Extend PromptingService with response tracking
    - Add `logPromptResponse(taskId: string, response: PromptResponse)` method
    - Create PromptEvent object: `{ promptId: UUID, taskId, promptedAt, response, respondedAt }`
    - Use DataService.loadPromptEvents(), append new event, DataService.savePromptEvents()
    - [Source: docs/architecture/4-data-models.md#PromptEvent]
  - [x] Track 'complete' response
    - Created endpoint `POST /api/prompts/complete` for tracking
    - Frontend calls this endpoint after completing task via prompt
    - Include respondedAt timestamp (current ISO 8601)
  - [x] Track 'dismiss' response
    - Create endpoint `POST /api/prompts/dismiss` (accepts { taskId })
    - Route calls promptingService.logPromptResponse(taskId, 'dismiss')
    - Returns 200 OK
  - [x] Track 'snooze' response
    - In snooze endpoint, calls logPromptResponse(taskId, 'snooze')
  - [ ] Track 'timeout' response
    - Deferred: will be implemented when frontend adds timeout tracking
    - Can use dismiss endpoint to log timeouts
  - [x] Ensure prompts.json file is created if doesn't exist
    - DataService.loadPromptEvents() returns empty array if file missing
    - First savePromptEvents() creates the file

- [x] **Task 3: Wire Frontend Action Handlers** (AC: 1, 2, 3, 4)
  - **Prerequisites:** Story 4.3 PromptToast component must exist ‚úì
  - [x] Update `apps/web/src/services/prompts.ts` API client
    - Add `snooze(taskId: string): Promise<void>` method
    - Calls `POST /api/prompts/snooze` with body `{ taskId }`
    - Add `dismiss(taskId: string): Promise<void>` method for tracking
    - Calls `POST /api/prompts/dismiss` with body `{ taskId }`
    - Add `complete(taskId: string): Promise<void>` method for tracking
    - [Source: docs/architecture/6-components.md#7. API Client Layer]
  - [x] Implement onComplete handler in PromptToast integration (AC: 1, 2)
    - In `TaskListView.tsx` (where PromptToast is rendered)
    - onComplete callback:
      - Call prompts.complete(taskId) to track response
      - Call handleComplete(taskId) which calls tasks.complete() API
      - Dismiss toast (via dismissCurrent() from usePromptQueue)
      - Celebration triggers automatically from Epic 3 completion flow
    - Add error handling: if API call fails, show error toast, keep prompt visible
  - [x] Implement onDismiss handler (AC: 3)
    - onDismiss callback:
      - Call prompts.dismiss(taskId) for tracking
      - Call dismissCurrent() from usePromptQueue to remove toast
      - Non-critical errors ignored (toast dismisses anyway)
  - [x] Implement onSnooze handler (AC: 4)
    - onSnooze callback:
      - Call prompts.snooze(taskId) API
      - Dismiss toast (via dismissCurrent())
    - Add error handling: if API call fails, show error toast, keep prompt visible
  - [x] Verify PromptToast component passes all action handlers
    - Component receives: onComplete, onDismiss, onSnooze as props
    - Buttons trigger respective callbacks with taskId
    - [Source: docs/stories/4.3.toast-notification-component-non-blocking-prompt-display.md]

- [x] **Task 4: Write Backend Integration Tests** (AC: 10)
  - [x] Extend `apps/server/tests/integration/api/prompts.test.ts`
  - [x] Test: POST /api/prompts/snooze returns 200 OK for valid task
    - Create test task, call snooze endpoint
    - Verify 200 status, empty response body
    - Verify prompt response logged
  - [x] Test: POST /api/prompts/snooze returns 404 for non-existent task
    - Call snooze with random UUID
    - Verify 404 status and error message
  - [x] Test: POST /api/prompts/snooze returns 400 for invalid taskId
    - Call with invalid UUID format ("invalid-uuid")
    - Verify 400 status and validation error
  - [x] Test: POST /api/prompts/snooze returns 400 for missing taskId
    - Call with empty body
    - Verify 400 status and validation error
  - [x] Test: Snooze cancellation when task completed
    - Documents that validation happens in onSnoozedPrompt
    - Task completion prevents prompt generation when timer fires
  - [x] Test: Snooze cancellation when task deleted
    - Documents that validation happens in onSnoozedPrompt
    - Task deletion prevents prompt generation when timer fires
  - [x] Test: 24-hour cooldown prevents duplicate prompts
    - Generate prompt for task, verify task filtered from next selection
    - Validates recentlyPromptedTasks Map functionality
  - [x] Test: Prompt response logging (complete/dismiss/snooze)
    - Test all three response types
    - Verify PromptEvent created in prompts.json with correct fields
    - [Source: docs/architecture/10-testing-strategy.md#Backend Tests]

- [x] **Task 5: Write Frontend Integration Tests** (AC: 10)
  - [x] Create `apps/web/tests/integration/PromptResponseFlow.test.tsx`
  - [x] Test: Complete action triggers task completion and celebration
    - Mock useSSE hook to return test prompts
    - Render TaskListView with mocked API (MSW)
    - Click "Complete" button on toast
    - Verify both prompts.complete() and tasks.complete() APIs called
    - Verify toast dismissed
    - Verify task removed from list
  - [x] Test: Dismiss action removes toast immediately
    - Mock prompt via useSSE
    - Click "Dismiss" button
    - Verify toast removed from DOM
    - Verify dismiss tracking API called
    - Verify task remains in list
  - [x] Test: Snooze action calls snooze API and dismisses toast
    - Mock prompt via useSSE
    - Click "Snooze" button
    - Verify prompts.snooze() API called with correct taskId
    - Verify toast dismissed
    - Verify task remains in list
  - [x] Test: Error handling for failed complete action
    - Mock API to return error on complete
    - Click "Complete" button
    - Verify error message shown to user
    - Verify task rollback (remains in list)
  - [x] Test: Error handling for failed snooze action
    - Mock API to return error on snooze
    - Click "Snooze" button
    - Verify error message shown
  - [x] Test: Multiple prompts in sequence
    - Queue two prompts, dismiss first
    - Verify second prompt appears after 500ms delay
  - [x] Use MSW (Mock Service Worker) for API mocking
    - Added handlers in `apps/web/tests/mocks/handlers.ts`
    - Mock POST /api/prompts/snooze, /complete, /dismiss responses
    - Mock PATCH /api/tasks/:id/complete responses
    - [Source: docs/architecture/10-testing-strategy.md#Frontend Tests]

- [x] **Task 6: Manual Testing Checklist** (AC: All)
  - [x] Enable prompting in config.json or via Settings UI
  - [x] Wait for SSE prompt or manually trigger via PromptingService
  - [x] Test Complete button:
    - Click Complete, verify task marked complete in task list
    - Verify celebration appears
    - Verify toast disappears
  - [x] Test Dismiss button:
    - Receive prompt, click Dismiss
    - Verify toast disappears immediately
    - Verify no other changes to task
  - [x] Test Snooze button:
    - Click Snooze, verify toast disappears
    - Wait 1 hour (or modify code to 10 seconds for testing)
    - Verify same task prompted again
  - [x] Test snooze cancellation:
    - Snooze task, then complete it manually before 1 hour
    - Wait for snooze timer, verify no prompt appears
  - [x] Test 24-hour cooldown:
    - Note task that was prompted
    - Verify same task not prompted again within 24 hours
  - [x] Verify prompt response tracking:
    - Check `data/prompts.json` file
    - Verify PromptEvent entries created with correct response types
  - [x] Test error scenarios:
    - Stop backend, try to complete/snooze from prompt
    - Verify graceful error messages shown

## Dev Notes

### Relevant Source Tree

**Files Modified/Created in This Story:**

```
simple-todo/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompts.ts                    [MODIFY - add snooze endpoint]
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ PromptingService.ts           [MODIFY - add snooze logic, tracking]
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ api/
‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ prompts.test.ts           [CREATE - integration tests]
‚îÇ   ‚îî‚îÄ‚îÄ web/
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompts.ts                    [MODIFY - add snooze/dismiss API methods]
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ App.tsx OR views/TaskListView.tsx [MODIFY - wire action handlers]
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ PromptToast.tsx               [EXISTS - from Story 4.3]
‚îÇ       ‚îî‚îÄ‚îÄ tests/
‚îÇ           ‚îî‚îÄ‚îÄ integration/
‚îÇ               ‚îî‚îÄ‚îÄ PromptResponseFlow.test.tsx   [CREATE - integration tests]
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ prompts.json                              [AUTO-CREATE - by DataService]
‚îî‚îÄ‚îÄ packages/
    ‚îî‚îÄ‚îÄ shared/
        ‚îî‚îÄ‚îÄ src/
            ‚îî‚îÄ‚îÄ types/
                ‚îî‚îÄ‚îÄ PromptEvent.ts                [EXISTS - from Epic 4 setup]
```

### Previous Story Insights

**From Story 4.3 (Toast Notification Component):**
- PromptToast component already created in `apps/web/src/components/PromptToast.tsx`
- Component props interface includes: `onComplete: (taskId: string) => void`, `onDismiss: () => void`, `onSnooze: (taskId: string) => void`
- usePromptQueue hook created in `apps/web/src/hooks/usePromptQueue.ts` for queue management
- Toast integration point is in `apps/web/src/App.tsx` or `TaskListView.tsx` (Task 6 of Story 4.3)
- Action handlers were stubbed in Story 4.3 - this story implements the full backend logic
- Story 4.3 noted: "onComplete and onSnooze call API methods, onDismiss does not" (lines 132-134 of 4.3 story)

**From Story 4.2 (SSE Infrastructure):**
- useSSE hook created in `apps/web/src/hooks/useSSE.ts`
- SSE endpoint: `GET /api/prompts/stream` established in `apps/server/src/routes/prompts.ts`
- ProactivePrompt data structure: `{ taskId: string, taskText: string, promptedAt: string }`

**From Story 4.1 (PromptingService Core):**
- PromptingService created in `apps/server/src/services/PromptingService.ts`
- Service has scheduler, task selection, and prompt generation logic
- Uses node-schedule or setTimeout for scheduling
- Reads config from DataService: `{ enabled: boolean, frequencyHours: number }`

### Data Models

**PromptEvent (for analytics tracking):**
[Source: docs/architecture/4-data-models.md#PromptEvent lines 325-364]
```typescript
export type PromptResponse = 'complete' | 'dismiss' | 'snooze' | 'timeout';

export interface PromptEvent {
  promptId: string;        // UUID
  taskId: string;          // UUID
  promptedAt: string;      // ISO 8601
  response: PromptResponse;
  respondedAt: string | null; // ISO 8601, null if timeout
}
```

**SnoozePromptDto (API request payload):**
[Source: docs/architecture/4-data-models.md#PromptEvent lines 358-364]
```typescript
export interface SnoozePromptDto {
  taskId: string;
}
```

**ProactivePrompt (SSE payload from Story 4.2):**
```typescript
export interface ProactivePrompt {
  taskId: string;
  taskText: string;
  promptedAt: string; // ISO 8601
}
```

### API Specifications

**New Endpoint: POST /api/prompts/snooze**
[Source: docs/architecture/5-api-specification.md#REST API Endpoints Summary line 22]

Request:
```http
POST /api/prompts/snooze
Content-Type: application/json

{
  "taskId": "uuid-string"
}
```

Response (200 OK):
```http
No body
```

Error Responses:
- 400 Bad Request: Invalid or missing taskId
- 404 Not Found: Task doesn't exist
- 500 Internal Server Error: Server-side error

**Existing Endpoint: PATCH /api/tasks/:id/complete**
[Source: docs/architecture/5-api-specification.md#REST API Endpoints Summary line 12]
- Used by Complete action
- Returns updated Task object
- Triggers celebration on frontend (Epic 3 functionality)

### Component Specifications

**PromptToast Component (created in Story 4.3):**
[Source: docs/stories/4.3.toast-notification-component-non-blocking-prompt-display.md lines 33-46]
- Location: `apps/web/src/components/PromptToast.tsx`
- Props interface:
  ```typescript
  interface PromptToastProps {
    prompt: ProactivePrompt;
    onComplete: (taskId: string) => void;
    onDismiss: () => void;
    onSnooze: (taskId: string) => void;
    position?: 'top-right' | 'bottom-right';
  }
  ```
- Three action buttons: Complete (green checkmark), Dismiss (X icon), Snooze (clock icon)
- Auto-dismiss timer: 30 seconds (handled in component)

**Frontend API Client:**
[Source: docs/architecture/6-components.md#7. API Client Layer lines 228-252]
- Location: `apps/web/src/services/prompts.ts`
- Need to add: `snooze(taskId: string): Promise<void>`
- Optionally add: `dismiss(taskId: string): Promise<void>` for tracking
- Base API client in `apps/web/src/services/api.ts` provides apiPost() helper

### File Locations

**Backend Files:**
- Routes: `apps/server/src/routes/prompts.ts` (extend existing file from Story 4.2)
- Service: `apps/server/src/services/PromptingService.ts` (extend existing from Story 4.1)
- Data: `data/prompts.json` (will be created by DataService if doesn't exist)
[Source: docs/architecture/2-high-level-architecture.md#Backend Directory Structure lines 206-270]

**Frontend Files:**
- API Client: `apps/web/src/services/prompts.ts` (extend existing from Story 4.2)
- Integration: `apps/web/src/App.tsx` or `apps/web/src/views/TaskListView.tsx` (action handlers)
- Component: `apps/web/src/components/PromptToast.tsx` (already exists from Story 4.3)
[Source: docs/architecture/2-high-level-architecture.md#Frontend Directory Structure lines 72-184]

**Shared Types:**
- Location: `packages/shared/src/types/PromptEvent.ts` (already exists from Epic 4 setup)
- Import path: `import type { PromptEvent, PromptResponse, SnoozePromptDto } from '@simple-todo/shared/types';`
[Source: docs/architecture/2-high-level-architecture.md#Shared Packages Structure lines 272-296]

### Technical Constraints

**Snooze Scheduling Approach:**
[Source: docs/architecture/6-components.md#5. PromptingService lines 139-190]
- Use in-memory Map for MVP: `snoozedPrompts: Map<taskId, timeoutId>`
- Store setTimeout ID to enable cancellation
- Use 1 hour delay: `setTimeout(() => {...}, 60 * 60 * 1000)`
- Alternative: use node-schedule for cron-like syntax
- **Note:** In-memory state will be lost on server restart (acceptable for MVP per PRD)
- **Future Enhancement:** Snooze duration currently hardcoded to 1 hour per PRD FR12; could be made configurable in future iteration

**24-Hour Cooldown Implementation:**
[Source: Epic 4 Story 4.4 AC 9]
- Track recently prompted tasks in Map: `recentlyPromptedTasks: Map<taskId, timestamp>`
- Filter in selectTaskForPrompt() method
- Periodically clean up old entries (hourly cleanup sufficient)
- Use Date.now() - timestamp > 24 * 60 * 60 * 1000 for comparison

**Prompt Response Tracking:**
[Source: docs/architecture/4-data-models.md#PromptEvent]
- Persist to `data/prompts.json` using DataService
- Generate unique promptId using UUID library: `import { v4 as uuidv4 } from 'uuid';`
- Use ISO 8601 timestamps: `new Date().toISOString()`
- Array of PromptEvent objects, append new events to array

**Error Handling:**
[Source: docs/architecture/2-high-level-architecture.md#Architectural Patterns lines 356-418]
- Backend services throw errors with descriptive messages
- Routes catch and map to HTTP status codes (400, 404, 500)
- Frontend shows user-friendly error toasts for API failures
- Use try-catch in all async handlers

### Testing

**Backend Testing:**
[Source: docs/architecture/10-testing-strategy.md#Backend Tests lines 75-102]
- **Test Framework:** Jest
- **Test Location:** `apps/server/tests/integration/api/prompts.test.ts`
- **Test Approach:** Integration tests with real DataService using temporary test files
- **Test Data:** Use factory functions from `apps/server/tests/helpers/factories.ts`
- **Coverage Target:** 70%+ for PromptingService business logic (NFR8)
- **Key Tests:**
  - POST /api/prompts/snooze validation (valid taskId, invalid taskId, missing taskId)
  - Snooze scheduling and cancellation logic
  - 24-hour cooldown enforcement
  - Prompt response logging (verify PromptEvent creation)

**Frontend Testing:**
[Source: docs/architecture/10-testing-strategy.md#Frontend Tests lines 104-126]
- **Test Framework:** Vitest + React Testing Library
- **Test Location:** `apps/web/tests/integration/PromptResponseFlow.test.tsx`
- **API Mocking:** Mock Service Worker (MSW) in `apps/web/tests/mocks/handlers.ts`
- **Test Approach:** Integration tests rendering full component trees with mocked APIs
- **Key Tests:**
  - Complete action: verify API call, toast dismissal, celebration appears
  - Dismiss action: verify toast removed, no API calls
  - Snooze action: verify snooze API call, toast dismissal
  - Error handling: API failures show error messages

**Test Commands:**
[Source: docs/architecture/10-testing-strategy.md#Testing Commands]
```bash
# Run server tests only
npm run test -w @simple-todo/server

# Run web tests only
npm run test -w @simple-todo/web

# Run all tests with coverage
npm run test:coverage
```

**Accessibility Testing:**
[Source: docs/architecture/14-accessibility-implementation.md#3. PromptToast Component]
- PromptToast already has accessibility requirements from Story 4.3
- Verify keyboard navigation works for all action buttons (Tab, Enter, Space)
- Ensure role="alert" for screen reader announcements
- Test with screen reader: "Prompt for task: [task text]. 3 actions: Complete, Dismiss, Snooze"

## Change Log

| Date       | Version | Description           | Author        |
| ---------- | ------- | --------------------- | ------------- |
| 2026-02-06 | 1.0     | Story created (Draft) | Scrum Master (Bob) |
| 2026-02-06 | 1.1     | Validation updates: Added template sections (Dev Agent Record, QA Results), source tree, future enhancement notes | Product Owner (Sarah) |
| 2026-02-06 | 1.2     | Implementation: Tasks 1-4 completed (Backend endpoints, tracking, frontend integration, backend tests) | Developer (James) |
| 2026-02-06 | 1.3     | Implementation: Task 5 completed (Frontend integration tests with MSW mocking) | Developer (James) |
| 2026-02-06 | 1.4     | Bug fix: Updated apiPost to handle empty response bodies from tracking endpoints | Developer (James) |
| 2026-02-06 | 1.5     | Bug fix: Fixed duplicate SSE connections - added useRef to useSSE hook for StrictMode compatibility | Developer (James) |
| 2026-02-07 | 1.6     | QA Fix: Added UUID validation to complete/dismiss endpoints via shared validation utility (addresses VAL-001, VAL-002) | Developer (James) |
| 2026-02-07 | 1.7     | Refactor: Consolidated UUID validation - removed duplicate from tasks.ts, updated to stricter regex pattern | Developer (James) |
| 2026-02-07 | 1.8     | Testing: Added comprehensive unit tests for isValidUuid validation utility | Developer (James) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5

### Debug Log References

None

### Completion Notes List

- **Backend Implementation**: Implemented full snooze, complete, and dismiss tracking endpoints with proper validation and error handling
- **Shared Types**: Added PromptEvent, PromptResponse, and SnoozePromptDto types to shared package
- **DataService Extension**: Added loadPromptEvents() and savePromptEvents() methods for analytics persistence
- **PromptingService Extension**:
  - Added snooze scheduling with in-memory Map tracking
  - Implemented 24-hour cooldown to prevent prompt repetition
  - Added automatic cleanup interval for recently prompted tasks
  - Implemented snooze cancellation via task validation (checks if task exists/active when timer fires)
  - Added logPromptResponse() method for analytics tracking
- **Frontend Integration**:
  - Updated prompts service with complete(), dismiss(), and snooze() methods
  - Wired action handlers in TaskListView with proper error handling
  - Handlers call both tracking endpoints and action endpoints
- **Backend Testing**: Added comprehensive integration tests for all snooze, complete, and dismiss endpoints
- **Frontend Testing**:
  - Created PromptResponseFlow.test.tsx with full integration tests
  - Mocked useSSE hook to control prompt delivery in tests
  - Tests cover: Complete with celebration, Dismiss, Snooze, Error handling, Multiple prompts in queue
  - Added MSW handlers for all prompt endpoints
- **Validation Approach**: Snooze cancellation implemented via validation in onSnoozedPrompt rather than explicit hooks to avoid coupling TaskService and PromptingService
- **Bug Fixes**:
  - Updated apiPost to handle empty response bodies (200 OK with no content) to prevent JSON parse errors when calling tracking endpoints
  - Fixed duplicate SSE connections caused by React StrictMode:
    - Added useRef to useSSE hook to track EventSource instance
    - Skip creating new connection if one already exists (prevents StrictMode double-render duplication)
    - Removed useSSE() call from TaskListView and passed prompts as prop from App.tsx
    - Ensures only ONE SSE connection exists even in React 18 StrictMode (development)
- **QA Fixes** (2026-02-07):
  - Created shared validation utility (`apps/server/src/utils/validation.ts`) with `isValidUuid()` function
  - Added UUID format validation to POST /api/prompts/complete endpoint (addresses QA issue VAL-001)
  - Added UUID format validation to POST /api/prompts/dismiss endpoint (addresses QA issue VAL-002)
  - Refactored snooze endpoint to use shared validation utility (eliminates code duplication)
  - Added UUID format validation tests for complete and dismiss endpoints (consistent with snooze endpoint tests)
  - **Additional Refactoring**: Removed duplicate `isValidUUID` function from `tasks.ts`, consolidated to shared utility
  - **Improved Validation**: Updated UUID regex to stricter pattern validating version bits ([1-5]) and variant bits ([89ab])
  - All 4 UUID validation calls in tasks.ts routes now use centralized validation function
  - **Comprehensive Testing**: Added unit tests for isValidUuid function with 27 test cases covering:
    - Valid UUIDs (v1-v5, all variant bits, case insensitivity)
    - Invalid version bits (0, 6, 7)
    - Invalid variant bits (0, 7, c, f)
    - Malformed formats (missing hyphens, wrong length, invalid characters)
    - Edge cases (empty string, nil UUID, real-world examples)

### File List

**Modified Files:**
- `packages/shared/src/types/PromptEvent.ts` - Added PromptEvent, PromptResponse, SnoozePromptDto types
- `packages/shared/src/types/index.ts` - Exported new types
- `apps/server/src/services/DataService.ts` - Added loadPromptEvents() and savePromptEvents() methods
- `apps/server/src/services/PromptingService.ts` - Extended with snooze, tracking, and cooldown logic
- `apps/server/src/routes/prompts.ts` - Added POST /snooze, /complete, /dismiss endpoints; QA Fix: Added UUID validation using shared utility
- `apps/server/src/routes/tasks.ts` - QA Fix: Removed duplicate isValidUUID function, now imports from shared validation utility
- `apps/server/tests/integration/api/prompts.test.ts` - Added integration tests for new endpoints; QA Fix: Added UUID format validation tests for complete/dismiss
- `apps/server/tests/unit/utils/validation.test.ts` - QA Fix: Unit tests for isValidUuid function (27 test cases)
- `apps/web/src/App.tsx` - Passes SSE prompts to TaskListView as prop (fixes duplicate SSE connections)
- `apps/web/src/hooks/useSSE.ts` - Added useRef to prevent duplicate EventSource creation in StrictMode
- `apps/web/src/services/api.ts` - Updated apiPost to handle empty response bodies (200 OK with no content)
- `apps/web/src/services/prompts.ts` - Added complete(), dismiss(), updated snooze() signature
- `apps/web/src/views/TaskListView.tsx` - Accepts ssePrompts as prop, wired action handlers with tracking calls
- `apps/web/tests/mocks/handlers.ts` - Added MSW handlers for prompt endpoints

**New Files:**
- `apps/web/tests/integration/PromptResponseFlow.test.tsx` - Integration tests for Complete/Dismiss/Snooze actions
- `apps/server/src/utils/validation.ts` - QA Fix: Shared validation utility with isValidUuid() function (stricter UUID regex pattern)
- `apps/server/tests/unit/utils/validation.test.ts` - QA Fix: Comprehensive unit tests for validation utility

**Data Files (Auto-created):**
- `data/prompts.json` - Created automatically by DataService on first prompt response log

## QA Results

### Review Date: 2026-02-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall**: The implementation demonstrates strong engineering practices with comprehensive error handling, proper separation of concerns, and excellent type safety. The code is well-documented, follows consistent patterns, and handles edge cases thoughtfully. The dual-layer approach (frontend + backend) for response tracking ensures analytics accuracy while maintaining user experience.

**Highlights**:
- Atomic file operations with retry logic in DataService prevent data corruption
- React StrictMode handling in useSSE prevents duplicate SSE connections
- Empty response body handling in apiPost (200 OK with no content) prevents JSON parse errors
- Memory management with cleanup intervals prevents leaks (recentlyPromptedTasks cleanup)
- Comprehensive error handling with rollback semantics in TaskListView
- 24-hour cooldown implementation elegantly filters tasks without external state

### Requirements Traceability Matrix

All 10 Acceptance Criteria have complete test coverage:

| AC | Description | Test Coverage | Status |
|----|-------------|---------------|--------|
| 1 | Complete button calls PATCH /api/tasks/:id/complete | PromptResponseFlow.test.tsx:42-120 | ‚úì PASS |
| 2 | Toast disappears, celebration appears | PromptResponseFlow.test.tsx:42-120 | ‚úì PASS |
| 3 | Dismiss removes toast immediately | PromptResponseFlow.test.tsx:169-223 | ‚úì PASS |
| 4 | Snooze dismisses and reschedules (1 hour) | PromptResponseFlow.test.tsx:272-326, prompts.test.ts:201-259 | ‚úì PASS |
| 5 | POST /api/prompts/snooze endpoint | prompts.test.ts:201-259, routes/prompts.ts:152-189 | ‚úì PASS |
| 6 | Snooze scheduling in memory Map | PromptingService.ts:28, 282-306 | ‚úì PASS |
| 7 | Cancel snooze on task completion/deletion | prompts.test.ts:351-391, PromptingService.ts:314-347 | ‚úì PASS |
| 8 | Prompt response tracking (analytics) | prompts.test.ts:243-325, PromptingService.ts:358-387 | ‚úì PASS |
| 9 | 24-hour cooldown (no duplicate prompts) | prompts.test.ts:327-349, PromptingService.ts:221-236 | ‚úì PASS |
| 10 | Integration tests for all responses | PromptResponseFlow.test.tsx (all), prompts.test.ts (all) | ‚úì PASS |

**Given-When-Then Mapping**:
- **Given** user receives prompt toast, **When** clicks Complete, **Then** task completes AND celebration shows AND toast dismisses (AC 1, 2)
- **Given** user receives prompt toast, **When** clicks Dismiss, **Then** toast removes immediately AND no other action (AC 3)
- **Given** user receives prompt toast, **When** clicks Snooze, **Then** toast dismisses AND prompt reschedules for 1 hour (AC 4)
- **Given** task is snoozed, **When** task completed/deleted before timer, **Then** scheduled prompt cancelled (AC 7)
- **Given** task was prompted, **When** selectTaskForPrompt runs within 24 hours, **Then** task filtered out (AC 9)

### Refactoring Performed

No refactoring performed during review. Code quality is high and follows established patterns.

### Compliance Check

- **Coding Standards**: ‚úì PASS
  - File naming conventions followed (PascalCase for components/services, camelCase for hooks)
  - Import order correct (React first, external, internal, relative)
  - TypeScript strict mode enforced
  - JSDoc comments present and comprehensive

- **Project Structure**: ‚úì PASS
  - Layered architecture maintained (routes ‚Üí services ‚Üí data)
  - Shared types in packages/shared
  - Tests mirror source structure
  - Separation of concerns respected

- **Testing Strategy**: ‚úì PASS
  - Integration tests at appropriate levels (backend: Jest, frontend: Vitest)
  - MSW mocking for frontend API calls
  - Isolated test data directories for backend
  - Coverage of happy paths and error scenarios

- **All ACs Met**: ‚úì PASS (see Requirements Traceability Matrix above)

### Issues Identified

#### üü° MEDIUM Severity - Missing UUID Validation (Recommended Fix)

**Location**: `apps/server/src/routes/prompts.ts`

**Issue**: The `/api/prompts/complete` (line 208-230) and `/api/prompts/dismiss` (line 247-269) endpoints validate taskId presence and type, but do NOT validate UUID format. The `/api/prompts/snooze` endpoint (line 164-169) correctly validates UUID format using regex.

**Impact**: Invalid UUIDs could be logged to `prompts.json`, potentially corrupting analytics data. While this doesn't affect core functionality (tracking is non-critical), it violates data integrity principles.

**Example**:
```typescript
// ‚ùå Current (complete/dismiss endpoints)
if (!dto.taskId || typeof dto.taskId !== 'string') {
  res.status(400).json({ error: 'Invalid or missing taskId' });
  return;
}
// Missing UUID format validation here

// ‚úÖ Should be (like snooze endpoint)
const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
if (!uuidRegex.test(dto.taskId)) {
  res.status(400).json({ error: 'Invalid taskId format (must be UUID)' });
  return;
}
```

**Recommendation**: Add UUID regex validation to both endpoints for consistency and data integrity. Use same pattern as snooze endpoint.

#### üü¢ LOW Severity - PromptEvent Timestamp Accuracy (Optional Enhancement)

**Location**: `apps/server/src/services/PromptingService.ts:367`

**Issue**: The `logPromptResponse()` method creates a new timestamp for `promptedAt` field:
```typescript
promptedAt: new Date().toISOString(), // Line 367
```

This should capture the **original prompt generation timestamp**, not the response timestamp. The PromptEvent interface has both `promptedAt` (when prompt was created) and `respondedAt` (when user responded), but currently both receive "now" timestamps.

**Impact**: Analytics cannot accurately calculate prompt-to-response time or identify which prompts generated earlier vs. later.

**Recommendation**: Track original prompt timestamp when generated and pass it to `logPromptResponse()`. This would require:
1. Store promptId ‚Üí timestamp mapping when prompts generated
2. Pass original timestamp to logPromptResponse
3. Or, accept promptedAt as parameter to logPromptResponse

**Note**: This is a minor analytics accuracy issue and doesn't affect functionality.

#### üü¢ LOW Severity - No Cleanup for Old PromptEvents (Future Enhancement)

**Location**: `apps/server/src/services/DataService.ts` (prompts.json)

**Issue**: The `prompts.json` file grows indefinitely as PromptEvents are appended. No cleanup mechanism exists for old events.

**Impact**: Over months/years, file size could grow large, potentially impacting load times. Not a near-term concern.

**Recommendation**: Add to backlog for future iteration - implement periodic cleanup (e.g., delete events older than 90 days). Acceptable for MVP.

### NFR Validation

#### Security
**Status**: üü° CONCERNS

**Findings**:
- ‚úì UUID validation in snooze endpoint prevents injection
- ‚úì No sensitive data exposure in logs or responses
- ‚úì Proper error messages don't leak implementation details
- ‚ö†Ô∏è Missing UUID validation in complete/dismiss endpoints (see Issues above)

**Notes**: Missing validation doesn't create immediate security risk but violates defense-in-depth principles.

#### Performance
**Status**: ‚úì PASS

**Findings**:
- ‚úì Efficient Map-based tracking (`snoozedPrompts`, `recentlyPromptedTasks`)
- ‚úì Cleanup intervals prevent memory leaks (hourly cleanup of recentlyPromptedTasks)
- ‚úì Atomic file writes with retry logic handle Windows file locking
- ‚úì Optimistic UI updates for responsive UX

**Notes**: No performance concerns. Memory footprint is minimal even with many tasks.

#### Reliability
**Status**: ‚úì PASS

**Findings**:
- ‚úì Comprehensive error handling with rollback semantics
- ‚úì Retry logic in DataService (3 attempts with exponential backoff)
- ‚úì Graceful degradation (tracking failures don't block user actions)
- ‚úì React StrictMode handling prevents duplicate SSE connections
- ‚úì Empty response body handling prevents JSON parse errors

**Notes**: Excellent reliability engineering. Code handles transient failures gracefully.

#### Maintainability
**Status**: ‚úì PASS

**Findings**:
- ‚úì Clear separation of concerns (routes, services, data)
- ‚úì Comprehensive JSDoc documentation
- ‚úì Consistent error handling patterns
- ‚úì Type-safe throughout with shared types
- ‚úì Test structure mirrors source structure

**Notes**: Code is highly maintainable. AI agents or human developers can easily extend.

### Test Architecture Assessment

**Backend Tests** (`apps/server/tests/integration/api/prompts.test.ts`):
- ‚úì Comprehensive integration tests for all endpoints
- ‚úì Isolated test data directories prevent cross-test pollution
- ‚úì Tests cover validation, success, and error scenarios
- ‚úì 24-hour cooldown logic validated
- ‚úì Snooze cancellation logic validated

**Frontend Tests** (`apps/web/tests/integration/PromptResponseFlow.test.tsx`):
- ‚úì Full user flow testing with React Testing Library
- ‚úì MSW mocking provides realistic API responses
- ‚úì Tests cover complete/dismiss/snooze actions
- ‚úì Error handling scenarios tested
- ‚úì Multiple prompts in sequence tested

**Test Level Appropriateness**: Excellent. Integration tests are the right level for this story. Unit tests for PromptingService methods would be nice-to-have but not critical given comprehensive integration coverage.

**Coverage Gaps**:
- Minor: No explicit test for `cleanupRecentlyPromptedTasks()` method (runs hourly)
- Acceptable: Cleanup is implicitly tested via 24-hour cooldown tests

### Improvements Checklist

- [ ] Add UUID format validation to POST /api/prompts/complete endpoint (apps/server/src/routes/prompts.ts:208-230)
- [ ] Add UUID format validation to POST /api/prompts/dismiss endpoint (apps/server/src/routes/prompts.ts:247-269)
- [ ] (Optional) Improve promptedAt timestamp accuracy in logPromptResponse to use original prompt time
- [ ] (Future) Add cleanup mechanism for old PromptEvents in prompts.json (90-day retention)

### Security Review

**Authentication/Authorization**: N/A - Story doesn't modify auth
**Input Validation**: CONCERNS - Missing UUID format validation in 2 endpoints (see Issues)
**Data Protection**: PASS - No sensitive data exposure
**Injection Prevention**: PASS - JSON.stringify prevents injection, UUID validation (where present) is correct
**Error Messages**: PASS - Error messages are user-friendly without implementation leaks

**Overall Security Posture**: Good, with minor validation gaps that should be addressed.

### Performance Considerations

**Memory Usage**: Excellent - Map-based tracking with automatic cleanup
**Network Efficiency**: Good - SSE connection reused, tracking endpoints are non-blocking
**Database/Storage**: Good - Atomic file writes prevent corruption
**Scalability**: Good for MVP - In-memory maps acceptable for single-server deployment

**No blocking performance concerns identified.**

### Files Modified During Review

None - no refactoring performed.

### Gate Status

**Gate**: CONCERNS ‚Üí `docs/qa/gates/4.4-prompt-response-handling-complete-dismiss-snooze.yml`

**Risk Profile**: N/A (not created - low risk story)

**NFR Assessment**: N/A (not created - comprehensive review above)

**Rationale**: The implementation is high-quality with excellent test coverage (all 10 ACs validated), strong error handling, and good architectural patterns. However, the missing UUID validation in 2 of 3 tracking endpoints creates a data integrity concern that should be addressed before production. This is a straightforward fix that will take minimal time.

**Top Issues**:
1. Missing UUID format validation in complete/dismiss endpoints (MEDIUM priority, easy fix)
2. PromptEvent timestamp accuracy could be improved (LOW priority, analytics enhancement)

**Quality Score**: 80/100 (100 - 10 for MEDIUM concerns - 10 for validation inconsistency)

### Recommended Status

**Status Recommendation**: ‚úó Changes Required - Address missing UUID validation in complete/dismiss endpoints

**Justification**: The story is functionally complete and well-tested, but the validation inconsistency should be corrected before marking Done. The fix is simple (copy UUID regex validation from snooze endpoint to complete/dismiss endpoints) and will take <15 minutes.

After validation is added:
1. Developer should update File List with changes
2. Re-run integration tests to confirm (tests should still pass)
3. Status can be updated to "Done"

**Next Actions**:
1. Add UUID validation to complete endpoint (3 lines)
2. Add UUID validation to dismiss endpoint (3 lines)
3. Run `npm run test:server -- --testPathPattern=prompts.test.ts` to verify
4. Update story status to Done
